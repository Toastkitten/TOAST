<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ˜éšŠç­è¡¨çœ‹æ¿</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    
    <style>
        :root {
            --bg-color: #f0f2f5; /* èƒŒæ™¯æ”¹ç¨å¾®æ·±ä¸€é»é»ï¼Œå°æ¯”æ›´å¥½ */
            /* ã€ä¿®æ”¹é» 3ã€‘æ™‚é–“è»¸å¯¬åº¦æ”¹å¯¬ */
            --sidebar-width: 480px; 
            --transition-speed: 0.3s;
            --primary-color: #1a73e8;
        }
        body {
            margin: 0; padding: 20px;
            background-color: var(--bg-color);
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh; /* æ”¹ç”¨ min-height é¿å…å…§å®¹è¢«åˆ‡æ‰ */
            box-sizing: border-box;
        }
        
        /* é ‚éƒ¨æ¨™é¡Œåˆ— */
        .header-bar {
            max-width: 1200px; margin: 0 auto 20px auto; /* é…åˆä¸»å®¹å™¨å¯¬åº¦ */
            height: 50px; display: flex; justify-content: space-between; align-items: center;
        }
        h1 { font-size: 1.5rem; color: #333; margin: 0; display: flex; align-items: center; gap: 10px;}

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-add {
            background-color: var(--primary-color); color: white; padding: 10px 24px;
            text-decoration: none; border-radius: 25px; font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: 0.2s;
        }
        .btn-add:hover { background-color: #1557b0; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2);}

        /* ã€ä¿®æ”¹é» 2ã€‘ä¸»ç‰ˆé¢å®¹å™¨ï¼šèª¿æ•´é‚Šè·èˆ‡å¤§å° */
        .layout-container {
            display: flex;
            /* è¨­å®šæœ€å¤§å¯¬åº¦ï¼Œè®“æ—é‚Šç•™ç™½ */
            max-width: 1200px; 
            /* ä¸Šä¸‹ç•™å¤šä¸€é»ç©ºç™½ï¼Œå·¦å³è‡ªå‹•ç½®ä¸­ */
            margin: 40px auto 60px auto; 
            /* å›ºå®šé«˜åº¦ï¼Œæ‰£æ‰ä¸Šä¸‹é‚Šè·èˆ‡æ¨™é¡Œç•¥æŠ“çš„é«˜åº¦ */
            height: 80vh; 
            min-height: 600px; /* è¨­å®šæœ€å°é«˜åº¦é˜²æ­¢å¤ªæ‰ */
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            overflow: hidden;
            position: relative;
            border: 1px solid #e0e0e0;
        }

        /* å·¦å´ï¼šè¡Œäº‹æ›† */
        .calendar-wrapper {
            flex: 1; transition: all var(--transition-speed) ease;
            padding: 30px; min-width: 0; overflow: hidden;
        }
        .layout-container.sidebar-active .calendar-wrapper {
            flex: 0 0 calc(100% - var(--sidebar-width));
        }
        /* FullCalendar æ¨£å¼å¾®èª¿ */
        .fc-toolbar-title { font-size: 1.25rem !important; }
        .fc-button { border-radius: 8px !important; }
        .fc-daygrid-event { border-radius: 4px; font-size: 0.85em; padding: 2px 4px;}
        /* ã€ä¿®æ”¹é» 4ã€‘è¢«é¸å–çš„æ—¥æœŸæ¨™ç¤º */
        .fc-highlight { background: rgba(255, 251, 0, 0.2) !important; } /* æ‹–æ›³é¸æ“‡æ™‚ */
        .fc-day-selected { background-color: rgba(255, 242, 0, 0.15) !important; transition: 0.2s;} /* é»æ“Šé¸å–æ™‚ */


        /* å³å´ï¼šæ™‚é–“è»¸ */
        .timeline-wrapper {
            width: 0; opacity: 0; background-color: #fff;
            border-left: 1px solid #eee; transition: all var(--transition-speed) ease;
            display: flex; flex-direction: column; position: relative;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05); z-index: 10;
        }
        .layout-container.sidebar-active .timeline-wrapper {
            width: var(--sidebar-width); opacity: 1;
        }
        .timeline-header {
            padding: 0 20px; background: #fafafa; border-bottom: 1px solid #eee;
            font-weight: bold; display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0; font-size: 1.1rem; color: #444;
        }
        .close-btn { cursor: pointer; color: #999; padding: 8px; font-size: 1.4rem; transition: 0.2s; line-height: 1;}
        .close-btn:hover { color: #333; background: #eee; border-radius: 50%;}

        .timeline-scroll-area { flex: 1; overflow-y: auto; position: relative; background: #fff; }
        /* æ™‚é–“åˆ»åº¦ */
        .time-slot {
            height: 60px; /* æ¯ä¸€å°æ™‚ 60px */
            border-bottom: 1px solid #f0f0f0; position: relative; box-sizing: border-box;
        }
        .time-slot span {
            position: absolute; top: -10px; left: 15px; background: #fff; padding: 0 5px;
            color: #999; font-size: 0.75rem; font-family: monospace; font-weight: 500;
        }
        /* æ™‚é–“è»¸èƒŒæ™¯æ ¼ç·š */
        .time-slot::after {
             content: ''; position: absolute; top: 30px; left: 60px; right: 0;
             border-bottom: 1px dashed #f5f5f5; height: 0;
        }

        /* ã€ä¿®æ”¹é» 5ã€‘äº‹ä»¶å€å¡Šï¼šæ”¯æ´ä¸¦æ’é¡¯ç¤º */
        .timeline-event {
            position: absolute;
            /* left å’Œ width æ”¹ç”± JS å‹•æ…‹è¨ˆç®— */
            border-radius: 6px; padding: 8px 12px;
            font-size: 0.9rem; color: white; overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 0 0 1px rgba(255,255,255,0.1);
            cursor: pointer; z-index: 10; opacity: 0.95; transition: all 0.2s ease;
            border-left: 4px solid rgba(0,0,0,0.15); box-sizing: border-box;
        }
        .timeline-event:hover { z-index: 20; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); opacity: 1;}
        .event-time-label { font-size: 0.75em; opacity: 0.85; margin-top: 4px; display: block;}
    </style>
</head>
<body>

    <div class="header-bar">
        <h1>ğŸ“… åœ˜éšŠå…±åŒç­è¡¨</h1>
        <a href="https://forms.gle/ZMxuuTAANsgGDKZ38" target="_blank" class="btn-add">
            â• æ–°å¢/å¡«å¯«ç­è¡¨
        </a>
    </div>

    <div class="layout-container" id="layoutContainer">
        <div class="calendar-wrapper">
            <div id='calendar'></div>
        </div>

        <div class="timeline-wrapper">
            <div class="timeline-header">
                <span id="timeline-date-title">è«‹é¸æ“‡æ—¥æœŸ</span>
                <span class="close-btn" onclick="closeTimeline()" title="é—œé–‰">Ã—</span>
            </div>
            <div class="timeline-scroll-area" id="timeline-grid">
                </div>
        </div>
    </div>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/zh-tw.js"></script>

<script>
    // ================== è¨­å®šå€ ==================
    // ä½ çš„ Sheet ID
    const SHEET_ID = '1N4Yj5JTKoeX4cbe4lexap2muaKtTpMwcqPOUjTpbN1Q'; 
    // ä½ çš„ Database åˆ†é  GID (å¦‚æœä¸æ˜¯ç¬¬ä¸€é ï¼Œè«‹ä¿®æ”¹é€™è£¡)
    const GID = '0#gid=0'; 

    const COLOR_MAP = {
        'ç´…è‰²': '#E74C3C', 'è—è‰²': '#3498DB', 'ç¶ è‰²': '#2ECC71',
        'æ©˜è‰²': '#F39C12', 'ç´«è‰²': '#9B59B6', 'ç°è‰²': '#95A5A6',
        'default': '#34495E'
    };
    // ===========================================

    let allEvents = [];
    let calendar;
    let selectedDateEl = null; // ç”¨ä¾†è¨˜éŒ„ç›®å‰è¢«é¸å–çš„æ—¥æœŸå…ƒç´ 

    document.addEventListener('DOMContentLoaded', function() {
        initCalendar();
        initTimelineGrid();
        fetchData();
    });

    function initCalendar() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'zh-tw',
            initialView: 'dayGridMonth',
            height: '100%',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
            selectable: true, // ã€ä¿®æ”¹é» 4ã€‘å…è¨±é¸å–æ—¥æœŸ
            // é»æ“Šæ—¥æœŸç©ºç™½è™•
            dateClick: function(info) {
                handleDateSelection(info.dayEl); // è™•ç†é¸å–æ¨£å¼
                openTimeline(info.dateStr);
            },
            // é»æ“Šäº‹ä»¶è‰²å¡Š
            eventClick: function(info) {
                // æ‰¾åˆ°è©²äº‹ä»¶å°æ‡‰çš„æ—¥æœŸæ ¼å­
                const dateStr = info.event.startStr.split('T')[0];
                const dayEl = calendarEl.querySelector(`td[data-date="${dateStr}"]`);
                if (dayEl) handleDateSelection(dayEl);
                
                openTimeline(dateStr);
            },
            eventDisplay: 'block',
            eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false }
        });
        calendar.render();
    }

    // ã€ä¿®æ”¹é» 4ã€‘è™•ç†æ—¥æœŸé¸å–æ¨£å¼çš„å‡½å¼
    function handleDateSelection(newEl) {
        // ç§»é™¤èˆŠçš„é¸å–æ¨£å¼
        if (selectedDateEl) {
            selectedDateEl.classList.remove('fc-day-selected');
        }
        // åŠ ä¸Šæ–°çš„é¸å–æ¨£å¼
        if (newEl) {
            newEl.classList.add('fc-day-selected');
            selectedDateEl = newEl;
        }
    }

    function initTimelineGrid() {
        const grid = document.getElementById('timeline-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 24; i++) {
            let div = document.createElement('div');
            div.className = 'time-slot';
            div.innerHTML = `<span>${i.toString().padStart(2, '0')}:00</span>`;
            grid.appendChild(div);
        }
    }

    async function fetchData() {
        // ä½¿ç”¨ GID ç¢ºä¿è®€å–åˆ° Database åˆ†é 
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&tq=Select%20*&gid=${GID}`;
        console.log("æ­£åœ¨è®€å–:", url);

        try {
            const res = await fetch(url);
            const text = await res.text();
            // ä½¿ç”¨ Regex æŠ“å– JSONï¼Œé¿å…è¢«å‰é¢çš„ /*O_o*/ å¹²æ“¾
            const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\);/);
            if (match && match[1]) {
                const json = JSON.parse(match[1]);
                if (json.table && json.table.rows.length > 0) {
                    processData(json.table.rows);
                    console.log("è³‡æ–™è®€å–æˆåŠŸï¼Œå…±", json.table.rows.length, "ç­†");
                } else {
                    console.warn("è³‡æ–™åº«æ˜¯ç©ºçš„");
                }
            }
        } catch (err) {
            console.error('è®€å–éŒ¯èª¤:', err);
            alert('è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console è¨Šæ¯ã€‚');
        }
    }

    // ã€ä¿®æ”¹é» 1ã€‘å…¨æ–°çš„æ™‚é–“æ ¼å¼åŒ–å‡½å¼
    function normalizeGoogleTime(rawTime) {
        if (!rawTime) return null;
        const str = rawTime.toString();
        
        // é‡å° Google Sheet å‚³å›çš„ "Date(1899,11,30,6,0,0)" æ ¼å¼é€²è¡Œè§£æ
        // ä½¿ç”¨ Regex æŠ“å– Date(y,m,d, å°æ™‚, åˆ†é˜, ç§’) ä¸­çš„å°æ™‚å’Œåˆ†é˜
        const match = str.match(/Date\(\d+,\d+,\d+,(\d+),(\d+)/);
        
        if (match) {
            // match[1] æ˜¯å°æ™‚ï¼Œmatch[2] æ˜¯åˆ†é˜ã€‚è£œé›¶ç¢ºä¿æ˜¯å…©ä½æ•¸ã€‚
            let h = match[1].padStart(2, '0');
            let m = match[2].padStart(2, '0');
            return `${h}:${m}`;
        }
        
        // å¦‚æœä¸æ˜¯ä¸Šè¿°æ ¼å¼ï¼Œå˜—è©¦ç°¡å–®çš„ fallback (ä¾‹å¦‚åŸæœ¬å°±æ˜¯ "09:00")
        if (str.includes(':') && str.length <= 5) {
             return str;
        }

        return null; // è§£æå¤±æ•—
    }


    function processData(rows) {
        allEvents = rows.map(row => {
            // è®€å–æ¬„ä½ (è«‹ç¢ºä¿ Database åˆ†é é †åºæ­£ç¢º)
            const title = (row.c[1]?.v) || 'æœªå‘½å';
            const dateStart = (row.c[2]?.f) || (row.c[2]?.v);
            // ä½¿ç”¨æ–°çš„å‡½å¼è™•ç†æ™‚é–“
            const timeStart = normalizeGoogleTime(row.c[4]?.v) || '00:00';
            const timeEnd = normalizeGoogleTime(row.c[5]?.v) || '23:59';
            const colorName = (row.c[6]?.v) || 'default';

            if (!dateStart) return null;

            return {
                title: title, // é€™è£¡çš„ title æœƒé¡¯ç¤ºåœ¨æœˆæ›†ä¸Š
                start: `${dateStart}T${timeStart}`,
                end: `${dateStart}T${timeEnd}`,
                color: COLOR_MAP[colorName] || COLOR_MAP['default'],
                extendedProps: {
                    dateOnly: dateStart,
                    timeStart: timeStart,
                    timeEnd: timeEnd,
                    desc: `${timeStart} - ${timeEnd}`
                }
            };
        }).filter(e => e !== null);

        calendar.removeAllEvents();
        calendar.addEventSource(allEvents);
    }

    function openTimeline(dateStr) {
        const container = document.getElementById('layoutContainer');
        const dateTitle = document.getElementById('timeline-date-title');
        const grid = document.getElementById('timeline-grid');

        dateTitle.textContent = `${dateStr} è¡Œç¨‹ä¸€è¦½`;
        container.classList.add('sidebar-active');
        setTimeout(() => { calendar.updateSize(); }, 350);

        // æ¸…é™¤èˆŠäº‹ä»¶
        grid.querySelectorAll('.timeline-event').forEach(el => el.remove());

        // ç¯©é¸ç•¶æ—¥äº‹ä»¶ä¸¦æ’åº (ç‚ºäº†è¨ˆç®—é‡ç–Šï¼Œå¿…é ˆå…ˆæ’åº)
        const dayEvents = allEvents
            .filter(e => e.extendedProps.dateOnly === dateStr)
            .sort((a, b) => a.extendedProps.timeStart.localeCompare(b.extendedProps.timeStart));

        // ã€ä¿®æ”¹é» 5ã€‘è¨ˆç®—é‡ç–Šä¸¦æ¸²æŸ“
        renderOverlappingEvents(dayEvents, grid);
    }

    window.closeTimeline = function() {
        const container = document.getElementById('layoutContainer');
        container.classList.remove('sidebar-active');
        // é—œé–‰æ™‚ä¹Ÿç§»é™¤æ—¥æœŸé¸å–æ¨£å¼
        if (selectedDateEl) {
            selectedDateEl.classList.remove('fc-day-selected');
            selectedDateEl = null;
        }
        setTimeout(() => { calendar.updateSize(); }, 350);
    }

    // ã€ä¿®æ”¹é» 5ã€‘æ–°çš„æ¸²æŸ“å‡½å¼ï¼šè™•ç†æ™‚é–“é‡ç–Šä¸¦æ’
    function renderOverlappingEvents(events, container) {
        if (events.length === 0) return;

        // è¼”åŠ©å‡½å¼ï¼šå°‡ "09:30" è½‰ç‚ºåˆ†é˜æ•¸ (ä¾‹å¦‚ 9*60+30 = 570)
        const getMinutes = (timeStr) => {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        };

        // æº–å‚™è³‡æ–™ï¼šåŠ å…¥åˆ†é˜æ•¸ä»¥ä¾¿è¨ˆç®—
        const processedEvents = events.map(e => ({
            ...e,
            startMin: getMinutes(e.extendedProps.timeStart),
            endMin: getMinutes(e.extendedProps.timeEnd)
        }));

        // æ¼”ç®—æ³•ï¼šåˆ†çµ„é‡ç–Šçš„äº‹ä»¶
        let groups = []; // å­˜æ”¾ä¸€çµ„ä¸€çµ„é‡ç–Šçš„äº‹ä»¶
        if (processedEvents.length > 0) {
            let currentGroup = [processedEvents[0]];
            let maxEndTimeInGroup = processedEvents[0].endMin;

            for (let i = 1; i < processedEvents.length; i++) {
                const currentEvent = processedEvents[i];
                // å¦‚æœç•¶å‰äº‹ä»¶çš„é–‹å§‹æ™‚é–“ < ç›®å‰ç¾¤çµ„ä¸­æœ€æ™šçµæŸçš„æ™‚é–“ -> ç™¼ç”Ÿé‡ç–Š
                if (currentEvent.startMin < maxEndTimeInGroup) {
                    currentGroup.push(currentEvent);
                    // æ›´æ–°ç¾¤çµ„ä¸­æœ€æ™šçµæŸçš„æ™‚é–“
                    maxEndTimeInGroup = Math.max(maxEndTimeInGroup, currentEvent.endMin);
                } else {
                    // æ²’æœ‰é‡ç–Šï¼Œå°å­˜ç•¶å‰ç¾¤çµ„ï¼Œé–‹å§‹æ–°ç¾¤çµ„
                    groups.push(currentGroup);
                    currentGroup = [currentEvent];
                    maxEndTimeInGroup = currentEvent.endMin;
                }
            }
            groups.push(currentGroup); // åŠ å…¥æœ€å¾Œä¸€çµ„
        }

        // æ¸²æŸ“æ¯ä¸€çµ„
        const HOUR_HEIGHT = 60; // CSS ä¸­è¨­å®šçš„æ¯å°æ™‚é«˜åº¦
        
        groups.forEach(group => {
            const count = group.length; // é€™ä¸€çµ„æœ‰å¹¾å€‹äººé‡ç–Š
            const width = 100 / count;  // æ¯å€‹äººåˆ†åˆ°çš„å¯¬åº¦ç™¾åˆ†æ¯”

            group.forEach((event, index) => {
                // è¨ˆç®—ä½ç½®èˆ‡é«˜åº¦
                const top = (event.startMin / 60) * HOUR_HEIGHT;
                let duration = event.endMin - event.startMin;
                if (duration <= 15) duration = 30; // æœ€å°é«˜åº¦é˜²å‘†
                const height = (duration / 60) * HOUR_HEIGHT;
                const left = index * width; // è¨ˆç®—å·¦é‚Šè·ä½ç½®

                // å»ºç«‹å…ƒç´ 
                const el = document.createElement('div');
                el.className = 'timeline-event';
                // è¨­å®šå‹•æ…‹è¨ˆç®—å‡ºçš„æ¨£å¼
                el.style.top = `${top}px`;
                el.style.height = `${height}px`;
                el.style.backgroundColor = event.color;
                el.style.width = `calc(${width}% - 10px)`; // æ¸›ä¸€é»å¯¬åº¦ç”¢ç”Ÿé–“è·
                el.style.left = `calc(60px + ${left}%)`;   // 60px æ˜¯å·¦å´æ™‚é–“æ–‡å­—çš„å¯¬åº¦

                el.innerHTML = `
                    <strong>${event.title}</strong>
                    <span class="event-time-label">${event.extendedProps.desc}</span>
                `;

                el.onclick = (e) => {
                    e.stopPropagation();
                    alert(`${event.title}\næ™‚é–“ï¼š${event.extendedProps.desc}`);
                };
                container.appendChild(el);
            });
        });
    }
</script>
</body>
</html>
