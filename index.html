<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>共同班表</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    
    <style>
        /* ================= 全域變數 ================= */
        :root {
            --bg-color: #f0f2f5;
            --primary-color: #1a73e8;
            --calendar-width: 1100px; /* 行事曆固定寬度 */
            --sidebar-width: 500px;   /* 時間軸固定寬度 */
            --transition-speed: 0.35s;
        }

        body {
            margin: 0; padding: 20px;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            box-sizing: border-box;
            /* 修正手機滑動體驗，防止整個頁面被拉動 */
            overflow-y: auto;
            overscroll-behavior-y: none;
        }

        /* 標題列 */
        .header-bar {
            width: 100%; max-width: var(--calendar-width);
            margin: 0 auto 15px auto;
            height: 50px; display: flex; justify-content: space-between; align-items: center;
            transition: max-width var(--transition-speed) cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .layout-container.sidebar-active ~ .header-bar,
        body.sidebar-open .header-bar {
            max-width: calc(var(--calendar-width) + var(--sidebar-width));
        }

        h1 { font-size: 1.5rem; color: #333; margin: 0; font-weight: 700; display: flex; align-items: center; gap: 8px;}
        h1::before { content: ''; display: block; width: 6px; height: 24px; background: var(--primary-color); border-radius: 3px; }

        .btn-add {
            background-color: var(--primary-color); color: white; padding: 8px 20px;
            text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 0.95rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: 0.2s; white-space: nowrap;
        }
        .btn-add:hover { background-color: #1557b0; transform: translateY(-1px); }

        /* ================= 核心佈局 ================= */
        .layout-container {
            display: flex;
            position: relative;
            width: 100%; 
            max-width: var(--calendar-width);
            height: 85vh; min-height: 600px;
            margin: 0 auto 40px auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            overflow: hidden; /* 這裡會裁切超出的部分，所以內層必須能滾動 */
            border: 1px solid #e0e0e0;
            transition: max-width var(--transition-speed) cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .layout-container.sidebar-active {
            max-width: calc(var(--calendar-width) + var(--sidebar-width));
        }

        .calendar-wrapper {
            flex: 0 0 var(--calendar-width);
            width: var(--calendar-width);
            padding: 20px 30px;
            box-sizing: border-box;
            background: #fff;
        }

        /* 右側：時間軸區塊 */
        .timeline-wrapper {
            width: var(--sidebar-width);
            background: #fff;
            border-left: 1px solid #eee;
            
            /* 讓它可以滑動 */
            transform: translateX(100%);
            margin-right: calc(var(--sidebar-width) * -1);
            opacity: 0;
            
            /* 確保高度填滿，並使用 Flex 排版 */
            height: 100%;
            display: flex;
            flex-direction: column;
            
            transition: transform var(--transition-speed) cubic-bezier(0.25, 0.8, 0.25, 1),
                        margin-right var(--transition-speed) cubic-bezier(0.25, 0.8, 0.25, 1),
                        opacity var(--transition-speed) ease;
        }

        .layout-container.sidebar-active .timeline-wrapper {
            transform: translateX(0);
            margin-right: 0;
            opacity: 1;
        }

        /* ================= RWD 響應式 ================= */
        @media screen and (max-width: 1650px) {
            .layout-container { max-width: 100% !important; width: 96% !important; }
            .layout-container.sidebar-active { max-width: 100% !important; width: 96% !important; }
            .calendar-wrapper { width: 100%; flex: 1; }

            .timeline-wrapper {
                position: absolute;
                top: 0; right: 0; bottom: 0;
                margin-right: 0 !important;
                transform: translateX(100%);
                z-index: 50;
                box-shadow: -5px 0 20px rgba(0,0,0,0.1);
            }
            .layout-container.sidebar-active .timeline-wrapper { transform: translateX(0); }
        }

        @media screen and (max-width: 768px) {
            :root { --sidebar-width: 100%; }
            body { padding: 10px; }
            .header-bar { width: 100% !important; }
            .layout-container { height: calc(100vh - 80px); flex-direction: column; }
            .calendar-wrapper { padding: 10px; }
            .timeline-wrapper { width: 100% !important; border-left: none; z-index: 100; }
            .fc-toolbar { flex-wrap: wrap; gap: 8px; margin-bottom: 1em !important; }
            .fc-toolbar-title { font-size: 1.2rem !important; }
            .fc-button { padding: 0.4em 0.65em !important; font-size: 0.85em !important; }
        }

        /* ================= 時間軸內部樣式 (修復滾動) ================= */
        .timeline-header {
            padding: 0 20px; background: #fafafa; border-bottom: 1px solid #eee;
            font-weight: bold; display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0; font-size: 1.1rem; color: #444;
        }
        .close-btn { 
            cursor: pointer; color: #888; width: 36px; height: 36px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; line-height: 1; border-radius: 50%; transition: 0.2s;
        }
        .close-btn:hover { background: #e0e0e0; color: #333; }

        /* 這裡是最重要的修正區域 */
        .timeline-scroll-area { 
            flex: 1; 
            /* 【關鍵修復】防止內容撐大容器導致無法滾動 */
            min-height: 0; 
            
            overflow-y: auto; 
            overflow-x: hidden;
            position: relative; 
            background: #fff; 
            padding: 20px 0; /* 保持上下間距 */
        }

        .time-slot {
            height: 60px; border-bottom: 1px solid #f9f9f9; position: relative; box-sizing: border-box;
        }
        .time-slot span {
            position: absolute; top: -10px; left: 10px; background: #fff; padding: 0 5px;
            color: #bbb; font-size: 0.75rem; font-family: monospace;
        }
        .time-slot::after {
             content: ''; position: absolute; top: 30px; left: 50px; right: 0;
             border-bottom: 1px dashed #fcfcfc; height: 0;
        }

        .timeline-event {
            position: absolute; border-radius: 6px; padding: 8px 10px;
            font-size: 0.9rem; color: white; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1), inset 0 0 0 1px rgba(255,255,255,0.2);
            cursor: pointer; z-index: 10; opacity: 0.95; transition: all 0.2s ease;
            border-left: 4px solid rgba(0,0,0,0.2); box-sizing: border-box;
            white-space: nowrap; text-overflow: ellipsis; 
        }
        .timeline-event:hover { z-index: 20; transform: scale(1.02); box-shadow: 0 8px 16px rgba(0,0,0,0.15); opacity: 1;}
        .timeline-event strong { font-size: 0.95rem; display: block; margin-bottom: 2px; }
        .event-time-label { font-size: 0.75em; opacity: 0.9; display: block;}
        
        .fc-daygrid-event { border-radius: 3px; font-size: 0.85em; padding: 1px 4px; margin-top: 2px; font-weight: 500; border: none; cursor: pointer;}
        .fc-day-selected { background-color: rgba(26, 115, 232, 0.08) !important; transition: 0.2s;} 
        .fc-col-header-cell-cushion { padding: 8px 0; color: #666; font-weight: 600; }
        .fc-daygrid-day-number { color: #555; padding: 8px; }
    </style>
</head>
<body>

    <div class="header-bar">
        <h1>共同班表</h1>
        <a href="https://forms.gle/ZMxuuTAANsgGDKZ38" target="_blank" class="btn-add">➕ 新增班表</a>
    </div>

    <div class="layout-container" id="layoutContainer">
        <div class="calendar-wrapper"><div id='calendar'></div></div>
        <div class="timeline-wrapper">
            <div class="timeline-header">
                <span id="timeline-date-title">行程</span>
                <span class="close-btn" onclick="closeTimeline()" title="關閉">×</span>
            </div>
            <div class="timeline-scroll-area" id="timeline-grid"></div>
        </div>
    </div>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/zh-tw.js"></script>

<script>
    const SHEET_ID = '1N4Yj5JTKoeX4cbe4lexap2muaKtTpMwcqPOUjTpbN1Q'; 
    const GID = '0'; 
    
    const COLOR_MAP = {
        '紅色': '#E74C3C', '藍色': '#3498DB', '綠色': '#2ECC71',
        '橘色': '#F39C12', '紫色': '#9B59B6', '灰色': '#95A5A6', 'default': '#34495E'
    };

    let allTimelineEvents = [];
    let calendar;
    let selectedDateEl = null;

    document.addEventListener('DOMContentLoaded', function() {
        initCalendar();
        initTimelineGrid();
        fetchData();
    });

    function initCalendar() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'zh-tw',
            initialView: 'dayGridMonth',
            height: '100%',
            windowResize: function(view) {
                if (window.innerWidth < 768) { calendar.changeView('dayGridMonth'); }
            },
            headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
            selectable: true,
            displayEventTime: false, 
            dateClick: function(info) { handleDateSelection(info.dayEl); openTimeline(info.dateStr); },
            eventClick: function(info) {
                const dateStr = info.event.startStr.split('T')[0];
                const dayEl = calendarEl.querySelector(`td[data-date="${dateStr}"]`);
                if (dayEl) handleDateSelection(dayEl);
                openTimeline(dateStr);
            },
            eventDisplay: 'block'
        });
        calendar.render();
    }

    function handleDateSelection(newEl) {
        if (selectedDateEl) selectedDateEl.classList.remove('fc-day-selected');
        if (newEl) { newEl.classList.add('fc-day-selected'); selectedDateEl = newEl; }
    }

    function initTimelineGrid() {
        const grid = document.getElementById('timeline-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 24; i++) {
            let div = document.createElement('div');
            div.className = 'time-slot';
            div.innerHTML = `<span>${i.toString().padStart(2, '0')}:00</span>`;
            grid.appendChild(div);
        }
    }

    async function fetchData() {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&tq=Select%20*&gid=${GID}&_=${new Date().getTime()}`;
        try {
            const res = await fetch(url);
            const text = await res.text();
            const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\);/);
            if (match && match[1]) {
                const json = JSON.parse(match[1]);
                if (json.table && json.table.rows.length > 0) {
                    processData(json.table.rows);
                }
            }
        } catch (err) { console.error('讀取錯誤:', err); }
    }

    function normalizeGoogleTime(rawTime) {
        if (!rawTime) return null;
        const str = rawTime.toString();
        const match = str.match(/Date\(.*?,.*?,.*?,(\d+),(\d+)/);
        if (match) {
            let h = match[1].padStart(2, '0');
            let m = match[2].padStart(2, '0');
            return `${h}:${m}`;
        }
        if (str.includes(':')) {
             let parts = str.split(':');
             return `${parts[0].padStart(2,'0')}:${parts[1].padStart(2,'0')}`;
        }
        return null;
    }

    function processData(rows) {
        let rawEvents = [];
        rows.forEach(row => {
            const name = (row.c[1]?.v) || '未命名'; 
            const eventName = (row.c[2]?.v) || ''; 
            const dateStart = (row.c[3]?.f) || (row.c[3]?.v);
            const timeStart = normalizeGoogleTime(row.c[5]?.v) || '00:00';
            const timeEnd = normalizeGoogleTime(row.c[6]?.v) || '23:59';
            const colorName = (row.c[7]?.v) || 'default';

            if (!dateStart) return;

            const fullTitle = eventName && eventName !== name ? `${name} - ${eventName}` : name;

            const eventObj = {
                title: fullTitle, 
                name: name,
                start: `${dateStart}T${timeStart}`,
                end: `${dateStart}T${timeEnd}`,
                color: COLOR_MAP[colorName] || COLOR_MAP['default'],
                extendedProps: {
                    dateOnly: dateStart,
                    timeStart: timeStart,
                    timeEnd: timeEnd,
                    desc: `${timeStart} - ${timeEnd}`
                }
            };
            rawEvents.push(eventObj);
        });

        allTimelineEvents = rawEvents;

        let calendarUniqueMap = new Map();
        rawEvents.forEach(event => {
            const uniqueKey = `${event.extendedProps.dateOnly}-${event.name}`;
            if (!calendarUniqueMap.has(uniqueKey)) {
                calendarUniqueMap.set(uniqueKey, {
                    title: event.name,
                    start: event.extendedProps.dateOnly,
                    color: event.color,
                    allDay: true
                });
            }
        });

        const calendarEvents = Array.from(calendarUniqueMap.values());
        calendar.removeAllEvents();
        calendar.addEventSource(calendarEvents);
    }

    function openTimeline(dateStr) {
        const container = document.getElementById('layoutContainer');
        const dateTitle = document.getElementById('timeline-date-title');
        const grid = document.getElementById('timeline-grid');
        const body = document.body;
        
        dateTitle.textContent = `${dateStr}`;
        container.classList.add('sidebar-active');
        body.classList.add('sidebar-open');
        
        setTimeout(() => { calendar.updateSize(); }, 350);
        
        grid.querySelectorAll('.timeline-event').forEach(el => el.remove());
        const dayEvents = allTimelineEvents.filter(e => e.extendedProps.dateOnly === dateStr).sort((a, b) => a.extendedProps.timeStart.localeCompare(b.extendedProps.timeStart));
        renderOverlappingEvents(dayEvents, grid);
    }

    window.closeTimeline = function() {
        const container = document.getElementById('layoutContainer');
        const body = document.body;
        container.classList.remove('sidebar-active');
        body.classList.remove('sidebar-open');
        if (selectedDateEl) { selectedDateEl.classList.remove('fc-day-selected'); selectedDateEl = null; }
        setTimeout(() => { calendar.updateSize(); }, 350);
    }

    function renderOverlappingEvents(events, container) {
        if (events.length === 0) return;
        const getMinutes = (timeStr) => { const [h, m] = timeStr.split(':').map(Number); return h * 60 + m; };
        const processedEvents = events.map(e => ({ ...e, startMin: getMinutes(e.extendedProps.timeStart), endMin: getMinutes(e.extendedProps.timeEnd) }));
        let groups = [];
        if (processedEvents.length > 0) {
            let currentGroup = [processedEvents[0]];
            let firstEnd = processedEvents[0].endMin < processedEvents[0].startMin ? processedEvents[0].endMin + 1440 : processedEvents[0].endMin;
            let maxEndTimeInGroup = firstEnd;
            for (let i = 1; i < processedEvents.length; i++) {
                const currentEvent = processedEvents[i];
                let curEnd = currentEvent.endMin < currentEvent.startMin ? currentEvent.endMin + 1440 : currentEvent.endMin;
                if (currentEvent.startMin < maxEndTimeInGroup) { currentGroup.push(currentEvent); maxEndTimeInGroup = Math.max(maxEndTimeInGroup, curEnd); } 
                else { groups.push(currentGroup); currentGroup = [currentEvent]; maxEndTimeInGroup = curEnd; }
            }
            groups.push(currentGroup);
        }
        const HOUR_HEIGHT = 60; 
        const TOP_OFFSET = 20; 
        groups.forEach(group => {
            const count = group.length;
            const width = 100 / count;
            group.forEach((event, index) => {
                const top = (event.startMin / 60) * HOUR_HEIGHT + TOP_OFFSET;
                let diff = (event.endMin < event.startMin ? event.endMin + 1440 : event.endMin) - event.startMin;
                if (diff <= 0) diff = 30; 
                const height = (diff / 60) * HOUR_HEIGHT;
                const left = index * width;
                const el = document.createElement('div');
                el.className = 'timeline-event';
                el.style.top = `${top}px`;
                el.style.height = `${height}px`;
                el.style.backgroundColor = event.color;
                el.style.width = `calc(${width}% - 12px)`; 
                el.style.left = `calc(50px + ${left}% + 6px)`; 
                el.innerHTML = `<strong>${event.title}</strong><span class="event-time-label">${event.extendedProps.desc}</span>`;
                el.onclick = (e) => { e.stopPropagation(); alert(`${event.title}\n時間：${event.extendedProps.desc}`); };
                container.appendChild(el);
            });
        });
    }
</script>
</body>
</html>
